<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&amp;D Initiative Tracker</title>
    <style>
        :root {
            --color-bg-base: #0a0e1a;
            --color-bg-elevated: #050811;
            --color-bg-surface: #141824;
            --color-bg-muted: #1f2535;
            --color-text-primary: #e8dcc4;
            --color-text-secondary: #c4b59d;
            --color-text-muted: #8c7e6a;
            --color-text-accent: #d4af37;
            --color-primary: #d4af37;
            --color-primary-hover: #b8941f;
            --color-border: rgba(140, 126, 106, 0.3);
            --color-danger: #8b1e1e;
            --color-success: #2d5016;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --color-bg-base: #0a0e1a;
                --color-bg-elevated: #050811;
                --color-bg-surface: #141824;
                --color-bg-muted: #1f2535;
                --color-text-primary: #e8dcc4;
                --color-text-secondary: #c4b59d;
                --color-text-muted: #8c7e6a;
                --color-text-accent: #d4af37;
                --color-primary: #d4af37;
                --color-primary-hover: #b8941f;
                --color-border: rgba(140, 126, 106, 0.3);
                --color-danger: #8b1e1e;
                --color-success: #2d5016;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg-base);
            color: var(--color-text-primary);
            padding: 16px;
            line-height: 1.45;
        }

        .container {
            max-width: 96%;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.85rem;
            margin-bottom: 20px;
            color: var(--color-primary);
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            font-weight: 700;
            letter-spacing: 2px;
        }

        h2 {
            font-size: 1.3rem;
            margin-bottom: 14px;
            color: var(--color-text-primary);
        }

        .section {
            background: var(--color-bg-surface);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 2px solid var(--color-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.3fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th {
            background: var(--color-bg-muted);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border: 1px solid var(--color-border);
            color: var(--color-primary);
            text-transform: uppercase;
            font-size: 0.82rem;
            letter-spacing: 1px;
        }

        td {
            padding: 10px;
            border: 1px solid var(--color-border);
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 7px;
            background: var(--color-bg-base);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text-primary);
            font-size: 14px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 1px;
        }

        button {
            padding: 9px 18px;
            background: var(--color-primary);
            color: var(--color-bg-base);
            border: 2px solid var(--color-primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13.5px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            background: transparent;
            color: var(--color-primary);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
        }

        button.secondary {
            background: var(--color-bg-muted);
            color: var(--color-text-primary);
        }

        button.secondary:hover {
            background: var(--color-bg-elevated);
        }

        button.danger {
            background: var(--color-danger);
            color: white;
        }

        button.danger:hover {
            opacity: 0.9;
        }

        button.small {
            padding: 5px 11px;
            font-size: 11.5px;
        }

        button.damage-btn {
            background: #c53030;
            color: white;
            border: 2px solid #c53030;
            padding: 6px 10px;
            font-weight: bold;
        }

        button.damage-btn:hover {
            background: #9b2c2c;
            border-color: #9b2c2c;
            color: white;
            box-shadow: 0 0 10px rgba(197, 48, 48, 0.4);
        }

        button.healing-btn {
            background: #38a169;
            color: white;
            border: 2px solid #38a169;
            padding: 6px 10px;
            font-weight: bold;
        }

        button.healing-btn:hover {
            background: #2f855a;
            border-color: #2f855a;
            color: white;
            box-shadow: 0 0 10px rgba(56, 161, 105, 0.4);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .initiative-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--color-bg-elevated);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .initiative-result.player {
            border-left: 4px solid var(--color-primary);
        }

        .initiative-result.monster {
            border-left: 4px solid var(--color-danger);
        }

        .name {
            font-weight: 600;
            flex: 1;
        }

        .initiative-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-primary);
            min-width: 50px;
            text-align: center;
        }

        .hp-display {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .hp-controls {
            display: flex;
            gap: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--color-text-muted);
        }

        .row-container[draggable="true"] {
            cursor: grab;
            transition: background 0.2s ease;
            position: relative;
        }

        .row-container[draggable="true"]:hover {
            background: rgba(212, 175, 55, 0.08);
        }

        .row-container.dragging {
            opacity: 0.6;
            background: rgba(212, 175, 55, 0.15) !important;
            cursor: grabbing !important;
        }

        .row-container.drag-over-top::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--color-primary);
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.8);
            z-index: 10;
        }

        .row-container.drag-over-bottom::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--color-primary);
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.8);
            z-index: 10;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
            display: none;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            body {
                padding: 16px;
            }
        }

        /* Table wrapper for responsive scrolling */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 16px;
        }

        /* Row container for table row + remove button */
        .row-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
        }

        .row-container table {
            flex: 1;
            margin-top: 0;
        }

        .row-container .remove-btn {
            flex-shrink: 0;
            min-width: 32px;
            padding: 6px 8px;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ² D&amp;D Initiative Tracker</h1>

        <div class="main-grid">
            <!-- Left Column: Players and Monsters -->
            <div class="left-column">
                <!-- Players Table -->
                <div class="section">
                    <h2>Players</h2>
                    <div class="table-wrapper">
                        <table id="playersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Initiative</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div id="playersTableRows">
                        <div class="row-container">
                            <table>
                                <tbody>
                                    <tr>
                                        <td><input type="text" placeholder="Player Name" onkeydown="handleKeyNavigation(event, this)" /></td>
                                        <td><input type="number" placeholder="Initiative" onkeydown="handleKeyNavigation(event, this)" /></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="danger small remove-btn" onclick="removePlayerRow(this)">x</button>
                        </div>
                    </div>
                    <div class="button-group">
                        <button onclick="addPlayerRow()">+ Add Player</button>
                    </div>
                </div>

                <!-- Monsters Table -->
                <div class="section">
                    <h2>Monsters</h2>
                    <div class="table-wrapper">
                        <table id="monstersTable">
                            <thead>
                                <tr>
                                    <th>Prefix</th>
                                    <th>Count</th>
                                    <th>INI Mod</th>
                                    <th>HP</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div id="monstersTableRows">
                        <div class="row-container">
                            <table>
                                <tbody>
                                    <tr>
                                        <td><input type="text" placeholder="e.g. Goblin" onkeydown="handleKeyNavigation(event, this)" /></td>
                                        <td><input type="number" placeholder="Count" value="1" min="1" onkeydown="handleKeyNavigation(event, this)" /></td>
                                        <td><input type="number" placeholder="+0" value="0" onkeydown="handleKeyNavigation(event, this)" /></td>
                                        <td><input type="number" placeholder="HP" value="7" onkeydown="handleKeyNavigation(event, this)" /></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="danger small remove-btn" onclick="removeMonsterRow(this)">x</button>
                        </div>
                    </div>
                    <div class="button-group">
                        <button onclick="addMonsterRow()">+ Add Monster</button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Combat Tracker -->
            <div class="section" id="combatSection" style="display: none;">
                <h2>Combat Tracker</h2>
                <div class="table-wrapper">
                    <table id="combatTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Initiative</th>
                                <th>HP</th>
                                <th>Damage/Healing</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div id="combatTableRows">
                    <div id="combatTableBody">
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="addCombatRow()">+ Add Row</button>
                    <button class="secondary" onclick="resetCombat()">Reset Combat</button>
                </div>
            </div>
        </div>

        <!-- Roll Initiative Button -->
        <div class="section" style="text-align: center;">
            <button onclick="rollInitiative()" style="padding: 16px 32px; font-size: 18px;">
                ðŸŽ² Roll Initiative!
            </button>
        </div>
    </div>

    <script>
        // Select all text on first click, allow cursor positioning on second click
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'INPUT' && (e.target.type === 'text' || e.target.type === 'number')) {
                if (!e.target.hasAttribute('data-clicked')) {
                    e.target.select();
                    e.target.setAttribute('data-clicked', 'true');
                    
                    // Remove the attribute after a short delay when focus is lost
                    e.target.addEventListener('blur', function() {
                        setTimeout(() => {
                            e.target.removeAttribute('data-clicked');
                        }, 100);
                    }, { once: true });
                }
            }
        });

        function addPlayerRow() {
            const container = document.getElementById('playersTableRows');
            const rowContainer = document.createElement('div');
            rowContainer.className = 'row-container';
            rowContainer.innerHTML = `
                <table>
                    <tbody>
                        <tr>
                            <td><input type="text" placeholder="Player Name" onkeydown="handleKeyNavigation(event, this)" /></td>
                            <td><input type="number" placeholder="Initiative" onkeydown="handleKeyNavigation(event, this)" /></td>
                        </tr>
                    </tbody>
                </table>
                <button class="danger small remove-btn" onclick="removePlayerRow(this)">x</button>
            `;
            container.appendChild(rowContainer);
        }

        function removePlayerRow(button) {
            const container = document.getElementById('playersTableRows');
            if (container.children.length > 1) {
                button.closest('.row-container').remove();
            }
        }

        function addMonsterRow() {
            const container = document.getElementById('monstersTableRows');
            const rowContainer = document.createElement('div');
            rowContainer.className = 'row-container';
            rowContainer.innerHTML = `
                <table>
                    <tbody>
                        <tr>
                            <td><input type="text" placeholder="e.g. Goblin" onkeydown="handleKeyNavigation(event, this)" /></td>
                            <td><input type="number" placeholder="Count" value="1" min="1" onkeydown="handleKeyNavigation(event, this)" /></td>
                            <td><input type="number" placeholder="+0" value="0" onkeydown="handleKeyNavigation(event, this)" /></td>
                            <td><input type="number" placeholder="HP" value="7" onkeydown="handleKeyNavigation(event, this)" /></td>
                        </tr>
                    </tbody>
                </table>
                <button class="danger small remove-btn" onclick="removeMonsterRow(this)">x</button>
            `;
            container.appendChild(rowContainer);
        }

        function removeMonsterRow(button) {
            const container = document.getElementById('monstersTableRows');
            if (container.children.length > 1) {
                button.closest('.row-container').remove();
            }
        }

        function rollD20() {
            return Math.floor(Math.random() * 20) + 1;
        }

        function rollInitiative() {
            const combatants = [];

            // Get players
            const playerContainers = document.querySelectorAll('#playersTableRows .row-container');
            playerContainers.forEach(container => {
                const row = container.querySelector('tr');
                const name = row.cells[0].querySelector('input').value.trim();
                const initiative = parseInt(row.cells[1].querySelector('input').value);
                
                if (name && !isNaN(initiative)) {
                    combatants.push({
                        name: name,
                        initiative: initiative,
                        type: 'player',
                        hp: '',
                        maxHp: ''
                    });
                }
            });

            // Get monsters and roll for each
            const monsterContainers = document.querySelectorAll('#monstersTableRows .row-container');
            monsterContainers.forEach(container => {
                const row = container.querySelector('tr');
                const prefix = row.cells[0].querySelector('input').value.trim();
                const count = parseInt(row.cells[1].querySelector('input').value);
                const iniMod = parseInt(row.cells[2].querySelector('input').value) || 0;
                const hp = parseInt(row.cells[3].querySelector('input').value);

                if (prefix && count > 0 && !isNaN(hp)) {
                    for (let i = 1; i <= count; i++) {
                        const roll = rollD20();
                        const total = roll + iniMod;
                        combatants.push({
                            name: `${prefix} ${i}`,
                            initiative: total,
                            roll: roll,
                            modifier: iniMod,
                            type: 'monster',
                            hp: hp,
                            maxHp: hp
                        });
                    }
                }
            });

            if (combatants.length === 0) {
                alert('Please add at least one player or monster!');
                return;
            }

            // Sort by initiative (descending)
            combatants.sort((a, b) => b.initiative - a.initiative);

            // Populate combat tracker table
            const tbody = document.getElementById('combatTableBody');
            tbody.innerHTML = '';
            combatants.forEach(c => {
                const rowContainer = document.createElement('div');
                rowContainer.className = 'row-container';
                rowContainer.draggable = true;
                rowContainer.addEventListener('dragstart', handleDragStart);
                rowContainer.addEventListener('dragover', handleDragOver);
                rowContainer.addEventListener('drop', handleDrop);
                rowContainer.addEventListener('dragend', handleDragEnd);
                
                rowContainer.innerHTML = `
                    <table>
                        <tbody>
                            <tr>
                                <td>${c.name}</td>
                                <td>${c.initiative}</td>
                                <td>
                                    ${c.type === 'monster' ? `
                                    <div class="hp-display">
                                        <input type="number" value="${c.hp}" placeholder="HP" style="width: 100px;" data-maxhp="${c.maxHp}" class="hp-input" />
                                        <span style="color: var(--color-text-muted); font-size: 0.85rem;">/ ${c.maxHp}</span>
                                    </div>
                                    ` : ''}
                                </td>
                                <td>
                                    ${c.type === 'monster' ? `
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="number" placeholder="Â±" style="width: 70px;" class="damage-input" onkeydown="handleDamageKeydown(event, this)" />
                                        <button class="small damage-btn" onclick="applyDamage(this, 'damage')">âˆ’</button>
                                        <button class="small healing-btn" onclick="applyDamage(this, 'heal')">+</button>
                                    </div>
                                    ` : ''}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="danger small remove-btn" onclick="removeCombatRow(this)">x</button>
                `;
                tbody.appendChild(rowContainer);
            });

            // Show combat section
            document.getElementById('combatSection').style.display = 'block';
            document.getElementById('combatSection').scrollIntoView({ behavior: 'smooth' });
        }

        function addCombatRow() {
            const tbody = document.getElementById('combatTableBody');
            const rowContainer = document.createElement('div');
            rowContainer.className = 'row-container';
            rowContainer.draggable = true;
            rowContainer.addEventListener('dragstart', handleDragStart);
            rowContainer.addEventListener('dragover', handleDragOver);
            rowContainer.addEventListener('drop', handleDrop);
            rowContainer.addEventListener('dragend', handleDragEnd);
            
            rowContainer.innerHTML = `
                <table>
                    <tbody>
                        <tr>
                            <td><input type="text" placeholder="Name" style="width: 100%;" /></td>
                            <td><input type="number" placeholder="Initiative" style="width: 80px;" /></td>
                            <td>
                                <div class="hp-display">
                                    <input type="number" placeholder="HP" style="width: 100px;" class="hp-input" />
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" placeholder="Â±" style="width: 70px;" class="damage-input" onkeydown="handleDamageKeydown(event, this)" />
                                    <button class="small damage-btn" onclick="applyDamage(this, 'damage')">âˆ’</button>
                                    <button class="small healing-btn" onclick="applyDamage(this, 'heal')">+</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <button class="danger small remove-btn" onclick="removeCombatRow(this)">x</button>
            `;
            tbody.appendChild(rowContainer);
        }

        function removeCombatRow(button) {
            button.closest('.row-container').remove();
        }

        function resetCombat() {
            if (confirm('Do you really want to reset the combat?')) {
                document.getElementById('combatSection').style.display = 'none';
                document.getElementById('combatTableBody').innerHTML = '';
            }
        }

        // Drag and Drop functionality
        let draggedRow = null;

        function handleDragStart(e) {
            draggedRow = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            // Remove all drag-over classes first
            document.querySelectorAll('#combatTableBody .row-container').forEach(r => {
                r.classList.remove('drag-over-top', 'drag-over-bottom');
            });
            
            const rowContainer = e.target.closest('.row-container');
            if (rowContainer && rowContainer !== draggedRow && rowContainer.parentNode === draggedRow.parentNode) {
                const rect = rowContainer.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                
                // Determine if cursor is in top or bottom half
                if (e.clientY < midpoint) {
                    rowContainer.classList.add('drag-over-top');
                } else {
                    rowContainer.classList.add('drag-over-bottom');
                }
            }
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            const rowContainer = e.target.closest('.row-container');
            if (rowContainer && draggedRow && rowContainer !== draggedRow && rowContainer.parentNode === draggedRow.parentNode) {
                const rect = rowContainer.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                const tbody = rowContainer.parentNode;
                
                // Insert based on cursor position
                if (e.clientY < midpoint) {
                    tbody.insertBefore(draggedRow, rowContainer);
                } else {
                    tbody.insertBefore(draggedRow, rowContainer.nextSibling);
                }
            }
            
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('#combatTableBody .row-container').forEach(row => {
                row.classList.remove('drag-over-top', 'drag-over-bottom');
            });
        }

        // Damage application
        function handleDamageKeydown(event, input) {
            if (event.key === 'Enter') {
                event.preventDefault();
                // Find the damage button (red minus button)
                const damageButton = input.parentElement.querySelector('.damage-btn');
                applyDamage(damageButton, 'damage');
            }
        }

        function applyDamage(button, type) {
            const row = button.closest('tr');
            const damageInput = row.querySelector('.damage-input');
            const hpInput = row.querySelector('.hp-input');
            
            const value = parseInt(damageInput.value);
            const currentHp = parseInt(hpInput.value) || 0;
            
            if (!isNaN(value)) {
                let newHp;
                if (type === 'heal') {
                    // Healing: add the value
                    newHp = currentHp + value;
                } else {
                    // Damage: subtract the value
                    newHp = Math.max(0, currentHp - value);
                }
                
                hpInput.value = newHp;
                damageInput.value = '';
                
                // Visual feedback
                if (type === 'heal') {
                    hpInput.style.color = '#38a169';
                } else {
                    hpInput.style.color = '#c53030';
                }
                
                setTimeout(() => {
                    hpInput.style.color = '';
                }, 500);
            }
        }

        // Constants
        const FOCUS_DELAY_MS = 10; // Brief delay to ensure DOM updates before focusing

        // Helper function to focus on first input of a row container
        function focusFirstInputInContainer(container) {
            setTimeout(() => {
                const newRowContainer = container.lastElementChild;
                if (newRowContainer) {
                    const row = newRowContainer.querySelector('tr');
                    if (row && row.cells.length > 0) {
                        const firstInput = row.cells[0].querySelector('input');
                        if (firstInput) {
                            firstInput.focus();
                            firstInput.select();
                        }
                    }
                }
            }, FOCUS_DELAY_MS);
        }

        // Helper function to add row based on container type
        function addRowForContainer(container) {
            const playersContainer = document.getElementById('playersTableRows');
            const monstersContainer = document.getElementById('monstersTableRows');
            
            if (container === playersContainer) {
                addPlayerRow();
            } else if (container === monstersContainer) {
                addMonsterRow();
            }
        }

        function handleKeyNavigation(event, input) {
            const cell = input.closest('td');
            const row = cell.closest('tr');
            const rowContainer = row.closest('.row-container');
            const cells = Array.from(row.cells);
            const currentIndex = cells.indexOf(cell);

            // Tab: Move to next cell or next row
            if (event.key === 'Tab' && !event.shiftKey) {
                event.preventDefault();
                if (currentIndex < cells.length - 1) {
                    // Move to next cell in same row
                    const nextInput = cells[currentIndex + 1].querySelector('input');
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                } else {
                    // Last cell in row - move to first cell of next row or create new row
                    const container = rowContainer.parentElement;
                    const rowContainers = Array.from(container.children);
                    const rowIndex = rowContainers.indexOf(rowContainer);
                    
                    if (rowIndex === rowContainers.length - 1) {
                        // Last row - add new row and focus first input
                        addRowForContainer(container);
                        focusFirstInputInContainer(container);
                    } else {
                        // Move to first cell of next row
                        const nextRowContainer = rowContainers[rowIndex + 1];
                        if (nextRowContainer) {
                            const row = nextRowContainer.querySelector('tr');
                            if (row && row.cells.length > 0) {
                                const firstInput = row.cells[0].querySelector('input');
                                if (firstInput) {
                                    firstInput.focus();
                                    firstInput.select();
                                }
                            }
                        }
                    }
                }
            }
            
            // Shift+Tab: Move to previous cell
            if (event.key === 'Tab' && event.shiftKey) {
                event.preventDefault();
                if (currentIndex > 0) {
                    const prevInput = cells[currentIndex - 1].querySelector('input');
                    if (prevInput) {
                        prevInput.focus();
                        prevInput.select();
                    }
                }
            }

            // Enter: Move to next row, create if needed
            if (event.key === 'Enter') {
                event.preventDefault();
                const container = rowContainer.parentElement;
                const rowContainers = Array.from(container.children);
                const rowIndex = rowContainers.indexOf(rowContainer);
                
                // Check if this is the last row
                if (rowIndex === rowContainers.length - 1) {
                    // Last row - add new row and focus first input
                    addRowForContainer(container);
                    focusFirstInputInContainer(container);
                } else {
                    // Move to same column in next row
                    const nextRowContainer = rowContainers[rowIndex + 1];
                    if (nextRowContainer) {
                        const row = nextRowContainer.querySelector('tr');
                        if (row && row.cells.length > currentIndex) {
                            const nextInput = row.cells[currentIndex].querySelector('input');
                            if (nextInput) {
                                nextInput.focus();
                                nextInput.select();
                            }
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
