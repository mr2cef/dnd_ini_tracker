<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&amp;D Initiative Tracker</title>
    <style>
        :root {
            --color-bg-base: #0a0e1a;
            --color-bg-elevated: #050811;
            --color-bg-surface: #141824;
            --color-bg-muted: #1f2535;
            --color-text-primary: #e8dcc4;
            --color-text-secondary: #c4b59d;
            --color-text-muted: #8c7e6a;
            --color-text-accent: #d4af37;
            --color-primary: #d4af37;
            --color-primary-hover: #b8941f;
            --color-border: rgba(140, 126, 106, 0.3);
            --color-danger: #8b1e1e;
            --color-success: #2d5016;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --color-bg-base: #0a0e1a;
                --color-bg-elevated: #050811;
                --color-bg-surface: #141824;
                --color-bg-muted: #1f2535;
                --color-text-primary: #e8dcc4;
                --color-text-secondary: #c4b59d;
                --color-text-muted: #8c7e6a;
                --color-text-accent: #d4af37;
                --color-primary: #d4af37;
                --color-primary-hover: #b8941f;
                --color-border: rgba(140, 126, 106, 0.3);
                --color-danger: #8b1e1e;
                --color-success: #2d5016;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg-base);
            color: var(--color-text-primary);
            padding: 16px;
            line-height: 1.45;
        }

        .container {
            max-width: 96%;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.85rem;
            margin-bottom: 20px;
            color: var(--color-primary);
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            font-weight: 700;
            letter-spacing: 2px;
        }

        h2 {
            font-size: 1.3rem;
            margin-bottom: 14px;
            color: var(--color-text-primary);
        }

        .section {
            background: var(--color-bg-surface);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 2px solid var(--color-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.3fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th {
            background: var(--color-bg-muted);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border: 1px solid var(--color-border);
            color: var(--color-primary);
            text-transform: uppercase;
            font-size: 0.82rem;
            letter-spacing: 1px;
        }

        td {
            padding: 10px;
            border: 1px solid var(--color-border);
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 7px;
            background: var(--color-bg-base);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text-primary);
            font-size: 14px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 1px;
        }

        button {
            padding: 9px 18px;
            background: var(--color-primary);
            color: var(--color-bg-base);
            border: 2px solid var(--color-primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13.5px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            background: transparent;
            color: var(--color-primary);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
        }

        button.secondary {
            background: var(--color-bg-muted);
            color: var(--color-text-primary);
        }

        button.secondary:hover {
            background: var(--color-bg-elevated);
        }

        button.danger {
            background: var(--color-danger);
            color: white;
        }

        button.danger:hover {
            opacity: 0.9;
        }

        button.small {
            padding: 5px 11px;
            font-size: 11.5px;
        }

        button.damage-btn {
            background: #c53030;
            color: white;
            border: 2px solid #c53030;
            padding: 6px 10px;
            font-weight: bold;
        }

        button.damage-btn:hover {
            background: #9b2c2c;
            border-color: #9b2c2c;
            color: white;
            box-shadow: 0 0 10px rgba(197, 48, 48, 0.4);
        }

        button.healing-btn {
            background: #38a169;
            color: white;
            border: 2px solid #38a169;
            padding: 6px 10px;
            font-weight: bold;
        }

        button.healing-btn:hover {
            background: #2f855a;
            border-color: #2f855a;
            color: white;
            box-shadow: 0 0 10px rgba(56, 161, 105, 0.4);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .initiative-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--color-bg-elevated);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .initiative-result.player {
            border-left: 4px solid var(--color-primary);
        }

        .initiative-result.monster {
            border-left: 4px solid var(--color-danger);
        }

        .name {
            font-weight: 600;
            flex: 1;
        }

        .initiative-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-primary);
            min-width: 50px;
            text-align: center;
        }

        .hp-display {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .hp-controls {
            display: flex;
            gap: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--color-text-muted);
        }

        tr[draggable="true"] {
            cursor: grab;
            transition: background 0.2s ease;
            position: relative;
        }

        tr[draggable="true"]:hover {
            background: rgba(212, 175, 55, 0.08);
        }

        tr.dragging {
            opacity: 0.6;
            background: rgba(212, 175, 55, 0.15) !important;
            cursor: grabbing !important;
        }

        tr.drag-over-top::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--color-primary);
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.8);
            z-index: 10;
        }

        tr.drag-over-bottom::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--color-primary);
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.8);
            z-index: 10;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
            display: none;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Default: show full header text, hide short text */
        .header-short {
            display: none;
        }

        .header-full {
            display: inline;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            body {
                padding: 16px;
            }

            /* Remove horizontal scrolling on mobile */
            .table-wrapper {
                overflow-x: visible;
            }

            /* Make table cells more compact on mobile */
            th, td {
                padding: 6px;
                font-size: 0.85rem;
            }

            /* Override all fixed-width inputs to be flexible on mobile */
            #combatTable input[type="number"],
            #combatTable input[type="text"] {
                width: 100% !important;
                min-width: 0 !important;
                max-width: 100%;
            }

            /* Make HP display stack on mobile */
            #combatTable .hp-display {
                flex-direction: column;
                gap: 2px;
                align-items: flex-start;
            }

            /* Stack damage/healing controls vertically on mobile */
            #combatTable td > div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 4px !important;
                align-items: stretch !important;
            }

            /* Hide damage/heal buttons by default on mobile */
            #combatTable .damage-btn,
            #combatTable .healing-btn {
                display: none;
                width: 100%;
                padding: 8px;
            }

            /* Show buttons when parent container has focus-within class */
            #combatTable .damage-controls-focused .damage-btn,
            #combatTable .damage-controls-focused .healing-btn {
                display: block;
            }

            /* Reduce table column widths on mobile */
            #combatTable th:nth-child(1),
            #combatTable td:nth-child(1) {
                width: 20%;
            }

            #combatTable th:nth-child(2),
            #combatTable td:nth-child(2) {
                width: 12%;
            }

            #combatTable th:nth-child(3),
            #combatTable td:nth-child(3) {
                width: 18%;
            }

            #combatTable th:nth-child(4),
            #combatTable td:nth-child(4) {
                width: 25%;
            }

            #combatTable th:nth-child(5),
            #combatTable td:nth-child(5) {
                width: 17%;
            }

            /* Keep button column small */
            th.button-col,
            td.button-col {
                width: 8%;
            }

            /* Make button text smaller on mobile */
            button.small {
                font-size: 10px;
                padding: 4px 8px;
            }

            /* Reduce heading sizes on mobile */
            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.1rem;
            }

            /* Show short header text on mobile, hide full text */
            .header-full {
                display: none;
            }

            .header-short {
                display: inline;
            }
        }

        /* Table wrapper for responsive scrolling */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 16px;
        }

        /* Hide header for button column */
        th.button-col {
            border: none;
            background: transparent;
            padding: 0;
            width: 40px;
        }

        /* Remove borders from button column cells */
        td.button-col {
            border: none;
            padding: 4px;
            width: 40px;
            vertical-align: middle;
        }

        /* Style for remove buttons in table */
        td.button-col button {
            min-width: 32px;
            padding: 6px 8px;
            font-size: 14px;
            font-weight: bold;
        }

        /* Footer styles */
        .footer {
            text-align: center;
            padding: 32px 16px 16px;
            margin-top: 32px;
        }

        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 6px;
        }

        .github-link:hover {
            color: var(--color-primary);
            background: var(--color-bg-elevated);
            transform: translateY(-2px);
        }

        .github-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        @media (max-width: 768px) {
            .footer {
                padding: 24px 16px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ² D&amp;D Initiative Tracker</h1>

        <div class="main-grid">
            <!-- Left Column: Players and Monsters -->
            <div class="left-column">
                <!-- Players Table -->
                <div class="section">
                    <h2>Players</h2>
                    <div class="table-wrapper">
                        <table id="playersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th><span class="header-full">Initiative</span><span class="header-short">Ini</span></th>
                                    <th class="button-col"></th>
                                </tr>
                            </thead>
                            <tbody id="playersTableBody">
                                <tr>
                                    <td><input type="text" placeholder="Player Name" onkeydown="handleKeyNavigation(event, this)" /></td>
                                    <td><input type="number" placeholder="Initiative" onkeydown="handleKeyNavigation(event, this)" /></td>
                                    <td class="button-col"><button class="danger small" onclick="removePlayerRow(this)">x</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="button-group">
                        <button onclick="addPlayerRow()">+ Add Player</button>
                    </div>
                </div>

                <!-- Monsters Table -->
                <div class="section">
                    <h2>Monsters</h2>
                    <div class="table-wrapper">
                        <table id="monstersTable">
                            <thead>
                                <tr>
                                    <th>Prefix</th>
                                    <th>Count</th>
                                    <th>INI Mod</th>
                                    <th>HP</th>
                                    <th class="button-col"></th>
                                </tr>
                            </thead>
                            <tbody id="monstersTableBody">
                                <tr>
                                    <td><input type="text" placeholder="e.g. Goblin" onkeydown="handleKeyNavigation(event, this)" /></td>
                                    <td><input type="number" placeholder="Count" value="1" min="1" onkeydown="handleKeyNavigation(event, this)" /></td>
                                    <td><input type="number" placeholder="+0" value="0" onkeydown="handleKeyNavigation(event, this)" /></td>
                                    <td><input type="number" placeholder="HP" value="7" onkeydown="handleKeyNavigation(event, this)" /></td>
                                    <td class="button-col"><button class="danger small" onclick="removeMonsterRow(this)">x</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="button-group">
                        <button onclick="addMonsterRow()">+ Add Monster</button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Combat Tracker -->
            <div class="section" id="combatSection" style="display: none;">
                <h2>Combat Tracker</h2>
                <div class="table-wrapper">
                    <table id="combatTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th><span class="header-full">Initiative</span><span class="header-short">Ini</span></th>
                                <th>HP</th>
                                <th><span class="header-full">Damage/Healing</span><span class="header-short">D/H</span></th>
                                <th>Condition</th>
                                <th class="button-col"></th>
                            </tr>
                        </thead>
                        <tbody id="combatTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="button-group">
                    <button onclick="addCombatRow()">+ Add Row</button>
                    <button class="secondary" onclick="resetCombat()">Reset Combat</button>
                </div>
            </div>
        </div>

        <!-- Roll Initiative Button -->
        <div class="section" style="text-align: center;">
            <button onclick="rollInitiative()" style="padding: 16px 32px; font-size: 18px;">
                ðŸŽ² Roll Initiative!
            </button>
        </div>
    </div>

    <!-- Footer with GitHub link -->
    <footer class="footer">
        <a href="https://github.com/mr2cef/dnd_ini_tracker" target="_blank" rel="noopener noreferrer" class="github-link" title="View on GitHub">
            <svg class="github-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
            </svg>
            <span>View on GitHub</span>
        </a>
    </footer>

    <script>
        // Select all text on first click, allow cursor positioning on second click
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'INPUT' && (e.target.type === 'text' || e.target.type === 'number')) {
                if (!e.target.hasAttribute('data-clicked')) {
                    e.target.select();
                    e.target.setAttribute('data-clicked', 'true');
                    
                    // Remove the attribute after a short delay when focus is lost
                    e.target.addEventListener('blur', function() {
                        setTimeout(() => {
                            e.target.removeAttribute('data-clicked');
                        }, 100);
                    }, { once: true });
                }
            }
        });

        // Mobile-responsive damage/heal buttons visibility
        // Check if we're on mobile (max-width: 768px)
        function isMobileView() {
            return window.matchMedia('(max-width: 768px)').matches;
        }

        // Handle focus on damage input to show buttons (mobile only)
        document.addEventListener('focus', function(e) {
            if (e.target.classList.contains('damage-input') && isMobileView()) {
                const container = e.target.parentElement;
                container.classList.add('damage-controls-focused');
            }
        }, true);

        // Handle blur on damage input to hide buttons (mobile only)
        document.addEventListener('blur', function(e) {
            if (e.target.classList.contains('damage-input') && isMobileView()) {
                const container = e.target.parentElement;
                // Small delay to allow button clicks to register
                setTimeout(() => {
                    container.classList.remove('damage-controls-focused');
                }, 150);
            }
        }, true);

        function addPlayerRow() {
            const tbody = document.getElementById('playersTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" placeholder="Player Name" onkeydown="handleKeyNavigation(event, this)" /></td>
                <td><input type="number" placeholder="Initiative" onkeydown="handleKeyNavigation(event, this)" /></td>
                <td class="button-col"><button class="danger small" onclick="removePlayerRow(this)">x</button></td>
            `;
            tbody.appendChild(row);
        }

        function removePlayerRow(button) {
            const tbody = document.getElementById('playersTableBody');
            if (tbody.children.length > 1) {
                button.closest('tr').remove();
            }
        }

        function addMonsterRow() {
            const tbody = document.getElementById('monstersTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" placeholder="e.g. Goblin" onkeydown="handleKeyNavigation(event, this)" /></td>
                <td><input type="number" placeholder="Count" value="1" min="1" onkeydown="handleKeyNavigation(event, this)" /></td>
                <td><input type="number" placeholder="+0" value="0" onkeydown="handleKeyNavigation(event, this)" /></td>
                <td><input type="number" placeholder="HP" value="7" onkeydown="handleKeyNavigation(event, this)" /></td>
                <td class="button-col"><button class="danger small" onclick="removeMonsterRow(this)">x</button></td>
            `;
            tbody.appendChild(row);
        }

        function removeMonsterRow(button) {
            const tbody = document.getElementById('monstersTableBody');
            if (tbody.children.length > 1) {
                button.closest('tr').remove();
            }
        }

        function rollD20() {
            return Math.floor(Math.random() * 20) + 1;
        }

        function rollInitiative() {
            const combatants = [];

            // Get players
            const playerRows = document.querySelectorAll('#playersTableBody tr');
            playerRows.forEach(row => {
                const name = row.cells[0].querySelector('input').value.trim();
                const initiative = parseInt(row.cells[1].querySelector('input').value);
                
                if (name && !isNaN(initiative)) {
                    combatants.push({
                        name: name,
                        initiative: initiative,
                        type: 'player',
                        hp: '',
                        maxHp: ''
                    });
                }
            });

            // Get monsters and roll for each
            const monsterRows = document.querySelectorAll('#monstersTableBody tr');
            monsterRows.forEach(row => {
                const prefix = row.cells[0].querySelector('input').value.trim();
                const count = parseInt(row.cells[1].querySelector('input').value);
                const iniMod = parseInt(row.cells[2].querySelector('input').value) || 0;
                const hp = parseInt(row.cells[3].querySelector('input').value);

                if (prefix && count > 0 && !isNaN(hp)) {
                    for (let i = 1; i <= count; i++) {
                        const roll = rollD20();
                        const total = roll + iniMod;
                        combatants.push({
                            name: `${prefix} ${i}`,
                            initiative: total,
                            roll: roll,
                            modifier: iniMod,
                            type: 'monster',
                            hp: hp,
                            maxHp: hp
                        });
                    }
                }
            });

            if (combatants.length === 0) {
                alert('Please add at least one player or monster!');
                return;
            }

            // Sort by initiative (descending)
            combatants.sort((a, b) => b.initiative - a.initiative);

            // Populate combat tracker table
            const tbody = document.getElementById('combatTableBody');
            tbody.innerHTML = '';
            combatants.forEach(c => {
                const row = document.createElement('tr');
                row.draggable = true;
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
                
                row.innerHTML = `
                    <td>${c.name}</td>
                    <td>${c.initiative}</td>
                    <td>
                        ${c.type === 'monster' ? `
                        <div class="hp-display">
                            <input type="number" value="${c.hp}" placeholder="HP" style="width: 100px;" data-maxhp="${c.maxHp}" class="hp-input" />
                            <span style="color: var(--color-text-muted); font-size: 0.85rem;">/ ${c.maxHp}</span>
                        </div>
                        ` : ''}
                    </td>
                    <td>
                        ${c.type === 'monster' ? `
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" placeholder="Â±" style="width: 70px;" class="damage-input" onkeydown="handleDamageKeydown(event, this)" />
                            <button class="small damage-btn" onclick="applyDamage(this, 'damage')">âˆ’</button>
                            <button class="small healing-btn" onclick="applyDamage(this, 'heal')">+</button>
                        </div>
                        ` : ''}
                    </td>
                    <td>
                        <input type="text" placeholder="Condition" style="width: 100%;" class="condition-input" />
                    </td>
                    <td class="button-col"><button class="danger small" onclick="removeCombatRow(this)">x</button></td>
                `;
                tbody.appendChild(row);
            });

            // Show combat section
            document.getElementById('combatSection').style.display = 'block';
            document.getElementById('combatSection').scrollIntoView({ behavior: 'smooth' });
        }

        function addCombatRow() {
            const tbody = document.getElementById('combatTableBody');
            const row = document.createElement('tr');
            row.draggable = true;
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);
            
            row.innerHTML = `
                <td><input type="text" placeholder="Name" style="width: 100%;" /></td>
                <td><input type="number" placeholder="Initiative" style="width: 80px;" /></td>
                <td>
                    <div class="hp-display">
                        <input type="number" placeholder="HP" style="width: 100px;" class="hp-input" />
                    </div>
                </td>
                <td>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" placeholder="Â±" style="width: 70px;" class="damage-input" onkeydown="handleDamageKeydown(event, this)" />
                        <button class="small damage-btn" onclick="applyDamage(this, 'damage')">âˆ’</button>
                        <button class="small healing-btn" onclick="applyDamage(this, 'heal')">+</button>
                    </div>
                </td>
                <td>
                    <input type="text" placeholder="Condition" style="width: 100%;" class="condition-input" />
                </td>
                <td class="button-col"><button class="danger small" onclick="removeCombatRow(this)">x</button></td>
            `;
            tbody.appendChild(row);
        }

        function removeCombatRow(button) {
            button.closest('tr').remove();
        }

        function resetCombat() {
            if (confirm('Do you really want to reset the combat?')) {
                document.getElementById('combatSection').style.display = 'none';
                document.getElementById('combatTableBody').innerHTML = '';
            }
        }

        // Drag and Drop functionality
        let draggedRow = null;

        function handleDragStart(e) {
            draggedRow = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            // Remove all drag-over classes first
            document.querySelectorAll('#combatTableBody tr').forEach(r => {
                r.classList.remove('drag-over-top', 'drag-over-bottom');
            });
            
            const row = e.target.closest('tr');
            if (row && row !== draggedRow && row.parentNode === draggedRow.parentNode) {
                const rect = row.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                
                // Determine if cursor is in top or bottom half
                if (e.clientY < midpoint) {
                    row.classList.add('drag-over-top');
                } else {
                    row.classList.add('drag-over-bottom');
                }
            }
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            const row = e.target.closest('tr');
            if (row && draggedRow && row !== draggedRow && row.parentNode === draggedRow.parentNode) {
                const rect = row.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                const tbody = row.parentNode;
                
                // Insert based on cursor position
                if (e.clientY < midpoint) {
                    tbody.insertBefore(draggedRow, row);
                } else {
                    tbody.insertBefore(draggedRow, row.nextSibling);
                }
            }
            
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('#combatTableBody tr').forEach(row => {
                row.classList.remove('drag-over-top', 'drag-over-bottom');
            });
        }

        // Damage application
        function handleDamageKeydown(event, input) {
            if (event.key === 'Enter') {
                event.preventDefault();
                // Find the damage button (red minus button)
                const damageButton = input.parentElement.querySelector('.damage-btn');
                applyDamage(damageButton, 'damage');
            }
        }

        function applyDamage(button, type) {
            const row = button.closest('tr');
            const damageInput = row.querySelector('.damage-input');
            const hpInput = row.querySelector('.hp-input');
            
            const value = parseInt(damageInput.value);
            const currentHp = parseInt(hpInput.value) || 0;
            
            if (!isNaN(value)) {
                let newHp;
                if (type === 'heal') {
                    // Healing: add the value
                    newHp = currentHp + value;
                } else {
                    // Damage: subtract the value
                    newHp = Math.max(0, currentHp - value);
                }
                
                hpInput.value = newHp;
                damageInput.value = '';
                
                // Visual feedback
                if (type === 'heal') {
                    hpInput.style.color = '#38a169';
                } else {
                    hpInput.style.color = '#c53030';
                }
                
                setTimeout(() => {
                    hpInput.style.color = '';
                }, 500);
            }
        }

        // Constants
        const FOCUS_DELAY_MS = 10; // Brief delay to ensure DOM updates before focusing

        // Helper function to focus on first input of a tbody
        function focusFirstInputInTbody(tbody) {
            setTimeout(() => {
                const lastRow = tbody.lastElementChild;
                if (lastRow && lastRow.cells.length > 0) {
                    const firstInput = lastRow.cells[0].querySelector('input');
                    if (firstInput) {
                        firstInput.focus();
                        firstInput.select();
                    }
                }
            }, FOCUS_DELAY_MS);
        }

        // Helper function to add row based on tbody id
        function addRowForTbody(tbody) {
            if (tbody.id === 'playersTableBody') {
                addPlayerRow();
            } else if (tbody.id === 'monstersTableBody') {
                addMonsterRow();
            }
        }

        function handleKeyNavigation(event, input) {
            const cell = input.closest('td');
            const row = cell.closest('tr');
            const tbody = row.closest('tbody');
            const cells = Array.from(row.cells);
            const currentIndex = cells.indexOf(cell);

            // Tab: Move to next cell or next row
            if (event.key === 'Tab' && !event.shiftKey) {
                event.preventDefault();
                
                // Try to find next cell with input in current row
                let foundNextInput = false;
                for (let i = currentIndex + 1; i < cells.length; i++) {
                    const nextInput = cells[i].querySelector('input');
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                        foundNextInput = true;
                        break;
                    }
                }
                
                // If no more input fields in current row, move to next row
                if (!foundNextInput) {
                    const rows = Array.from(tbody.children);
                    const rowIndex = rows.indexOf(row);
                    
                    if (rowIndex === rows.length - 1) {
                        // Last row - add new row and focus first input
                        addRowForTbody(tbody);
                        focusFirstInputInTbody(tbody);
                    } else {
                        // Move to first cell of next row
                        const nextRow = rows[rowIndex + 1];
                        if (nextRow && nextRow.cells.length > 0) {
                            const firstInput = nextRow.cells[0].querySelector('input');
                            if (firstInput) {
                                firstInput.focus();
                                firstInput.select();
                            }
                        }
                    }
                }
            }
            
            // Shift+Tab: Move to previous cell
            if (event.key === 'Tab' && event.shiftKey) {
                event.preventDefault();
                if (currentIndex > 0) {
                    const prevInput = cells[currentIndex - 1].querySelector('input');
                    if (prevInput) {
                        prevInput.focus();
                        prevInput.select();
                    }
                }
            }

            // Enter: Move to next row, create if needed
            if (event.key === 'Enter') {
                event.preventDefault();
                const rows = Array.from(tbody.children);
                const rowIndex = rows.indexOf(row);
                
                // Check if this is the last row
                if (rowIndex === rows.length - 1) {
                    // Last row - add new row and focus first input
                    addRowForTbody(tbody);
                    focusFirstInputInTbody(tbody);
                } else {
                    // Move to same column in next row
                    const nextRow = rows[rowIndex + 1];
                    if (nextRow && nextRow.cells.length > currentIndex) {
                        const nextInput = nextRow.cells[currentIndex].querySelector('input');
                        if (nextInput) {
                            nextInput.focus();
                            nextInput.select();
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
